# YouTube Sync Service

Автоматический сервис для синхронизации видео с YouTube каналов и плейлистов.

## Возможности

- ✅ Автоматическая загрузка видео с YouTube каналов и плейлистов
- ✅ Конфигурация через YAML файл
- ✅ Именование файлов в формате "Название-ГГГГ-ММ-ДД.расширение"
- ✅ Загрузка в наилучшем качестве
- ✅ Индивидуальная настройка периода для каждой ссылки
- ✅ Использование встроенных фильтров yt-dlp для эффективности
- ✅ Совместимость с Plex Media Server
- ✅ Docker контейнеризация
- ✅ Планировщик для автоматической синхронизации
- ✅ Логирование всех операций

## Быстрый старт

### 1. Настройка пользователя

Создайте `.env` файл для настройки UID/GID:

```bash
# Узнайте ваши UID и GID
id -u  # UID
id -g  # GID

# Создайте .env файл
cp .env.example .env
# Отредактируйте значения в .env файле
```

### 2. Настройка конфигурации

Отредактируйте файл `config.yaml`:

```yaml
youtube:
  channels:
    - url: "https://www.youtube.com/@вашканал1"
      period_days: 30  # Загружать за последние 30 дней
      output_dir: "./downloads/КАНАЛ1"  # Индивидуальная папка
    - url: "https://www.youtube.com/@вашканал2"
      period_days: 14  # Загружать за последние 2 недели
      output_dir: "./downloads/КАНАЛ2"
  
  playlists:
    - url: "https://www.youtube.com/playlist?list=PLваш_плейлист"
      period_days: 60  # Загружать за последние 2 месяца
      output_dir: "./downloads/плейлисты/МОЙ_ПЛЕЙЛИСТ"

download:
  output_dir: "./downloads"  # Папка по умолчанию
  quality: "bestvideo[height<=1080][ext=mp4]+bestaudio[ext=m4a]/bestvideo[height<=1080]+bestaudio/best[height<=1080][ext=mp4]/best[height<=720]/best"
  default_period_days: 30
  plex_naming: true  # Совместимость с Plex Media Server

scheduler:
  sync_interval_hours: 6
  first_run_time: "08:00"
```

### 3. Запуск с Docker Compose

```bash
# Сборка и запуск
docker-compose up -d

# Просмотр логов
docker-compose logs -f ytsync

# Остановка
docker-compose down
```

### 3. Запуск без Docker

```bash
# Установка зависимостей
pip install -r requirements.txt

# Запуск сервиса
python main.py
```

## Формат конфигурации

### Новый формат (с индивидуальными настройками):
```yaml
youtube:
  channels:
    - url: "https://www.youtube.com/@канал"
      period_days: 30
  playlists:
    - url: "https://www.youtube.com/playlist?list=список"
      period_days: 60
```

### Совместимость со старым форматом:
```yaml
youtube:
  channels:
    - "https://www.youtube.com/@канал"  # Будет использован default_period_days
  playlists:
    - "https://www.youtube.com/playlist?list=список"
```

## Структура проекта

```
ytsync/
├── main.py              # Основной код сервиса
├── config.yaml          # Конфигурация
├── requirements.txt     # Python зависимости
├── Dockerfile          # Образ Docker
├── docker-compose.yml  # Конфигурация Docker Compose
├── downloads/          # Папка для загруженных видео
└── logs/              # Папка для логов
```

## Настройки конфигурации

### YouTube источники
- `channels` - список каналов для синхронизации
  - `url` - URL канала
  - `period_days` - период загрузки для этого канала (опционально)
- `playlists` - список плейлистов для синхронизации
  - `url` - URL плейлиста
  - `period_days` - период загрузки для этого плейлиста (опционально)

### Настройки загрузки
- `output_dir` - папка для сохранения видео
- `quality` - качество загрузки (см. секцию "Настройки качества видео")
- `max_file_size` - максимальный размер файла в МБ (0 = без ограничений)
- `max_duration` - максимальная длительность в секундах (0 = без ограничений)
- `default_period_days` - период загрузки по умолчанию, если не указан для конкретной ссылки (30 дней)
- `plex_naming` - использовать формат именования совместимый с Plex Media Server (true/false)

## Настройки качества видео

Параметр `quality` поддерживает сложные форматы yt-dlp для выбора оптимального качества:

### Рекомендуемые настройки

**Высокое качество (1080p предпочтительно, 720p минимум):**
```yaml
quality: "bestvideo[height<=1080][ext=mp4]+bestaudio[ext=m4a]/bestvideo[height<=1080]+bestaudio/best[height<=1080][ext=mp4]/best[height<=720]/best"
```

**Стандартное качество (720p максимум):**
```yaml
quality: "bestvideo[height<=720][ext=mp4]+bestaudio[ext=m4a]/best[height<=720]/best"
```

**Экономия трафика (480p максимум):**
```yaml
quality: "bestvideo[height<=480]+bestaudio/best[height<=480]/best"
```

### Объяснение формата

- `bestvideo[height<=1080][ext=mp4]` - лучшее видео до 1080p в формате MP4
- `bestaudio[ext=m4a]` - лучшее аудио в формате M4A
- `+` - объединение видео и аудио потоков
- `/` - альтернативный вариант, если первый недоступен
- `best[height<=720]` - комбинированный формат до 720p (fallback)

### Дополнительные фильтры

Вы также можете добавить дополнительные ограничения:
- `[fps<=30]` - ограничение частоты кадров
- `[filesize<500M]` - ограничение размера файла
- `[vcodec^=avc1]` - предпочтение определенного кодека

### Планировщик
- `sync_interval_hours` - интервал между синхронизациями в часах
- `first_run_time` - время первого запуска в формате "ЧЧ:ММ"

## Именование файлов

### Стандартный формат
Файлы сохраняются в формате: `Название видео-ГГГГ-ММ-ДД.расширение`

Примеры:
- `Обзор нового телефона-2024-06-22.mp4`
- `Урок программирования-2024-06-21.mp4`

### Plex-совместимый формат
При включении `plex_naming: true` файлы организуются по структуре:

```
downloads/
├── ChannelName/
│   ├── Season 2024/
│   │   ├── ChannelName – 2024-06-22 – Обзор нового телефона.mp4
│   │   └── ChannelName – 2024-06-21 – Урок программирования.mp4
│   └── Season 2023/
│       └── ChannelName – 2023-12-15 – Старое видео.mp4
└── AnotherChannel/
    └── Season 2024/
        └── AnotherChannel – 2024-06-20 – Другое видео.mp4
```

Это обеспечивает полную совместимость с Plex Media Server для автоматического распознавания метаданных.

## Мониторинг

Сервис создает подробные логи в файле `ytsync.log` и выводит информацию в консоль.

Уровни логирования:
- `INFO` - общая информация о работе
- `ERROR` - ошибки загрузки
- `DEBUG` - детальная отладочная информация

## Совместимость с Plex

Сервис настроен для максимальной совместимости с Plex Media Server:
- Приоритет формата MP4
- Использование FFmpeg для конвертации
- Совместимые видео/аудио кодеки
- Эффективная фильтрация через встроенные параметры yt-dlp
- **Plex-совместимое именование файлов** (включается параметром `plex_naming: true`)
  - Структура папок: `ChannelName/Season YYYY/`
  - Формат файлов: `ChannelName – YYYY-MM-DD – VideoTitle.ext`
  - Автоматическое группирование видео по годам как "сезоны"
  - Полное соответствие стандартам Plex для дата-основанных TV шоу

## Требования

- Python 3.11+
- FFmpeg (устанавливается автоматически в Docker)
- Интернет соединение
- ~1GB свободного места на диске для временных файлов

## Настройка пользователя

Для правильных прав доступа к файлам нужно настроить UID/GID пользователя в контейнере.

### Способ 1: Через .env файл (рекомендуется)

```bash
# .env
USER_UID=1001
USER_GID=1001
```

### Способ 2: Через аргументы сборки

```bash
docker build --build-arg USER_UID=$(id -u) --build-arg USER_GID=$(id -g) -t ytsync .
```

### Способ 3: Через docker-compose напрямую

```yaml
# docker-compose.yml
services:
  ytsync:
    build:
      context: .
      args:
        USER_UID: 1001
        USER_GID: 1001
```

### Проверка прав доступа

```bash
# Проверить владельца загруженных файлов
ls -la downloads/

# Должно показать вашего пользователя:
# drwxr-xr-x 2 username usergroup 4096 Jun 22 10:30 downloads/
```

## Структура папок

```
downloads/
├── КАНАЛ1/                    # Видео первого канала
├── КАНАЛ2/                    # Видео второго канала
└── плейлисты/
    ├── МОЙ_ПЛЕЙЛИСТ/         # Видео конкретного плейлиста
    └── ДРУГОЙ_ПЛЕЙЛИСТ/      # Видео другого плейлиста
```

## Безопасность

- Сервис работает от непривилегированного пользователя
- Настраиваемые UID/GID для правильных прав доступа
- Ограничения по ресурсам в Docker
- Безопасная обработка имен файлов